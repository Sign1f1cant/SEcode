<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Code Review ç³»ç»Ÿæµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .main-content {
      padding: 30px;
    }

    .test-section {
      margin-bottom: 40px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .test-section:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .section-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      display: flex;
      justify-content: between;
      align-items: center;
    }

    .section-header h3 {
      color: #2c3e50;
      font-size: 1.3em;
      flex-grow: 1;
    }

    .section-header .status {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
    }

    .status.ready { background: #d4edda; color: #155724; }
    .status.testing { background: #fff3cd; color: #856404; }
    .status.success { background: #d1ecf1; color: #0c5460; }
    .status.error { background: #f8d7da; color: #721c24; }

    .section-content {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn.btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .btn.btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .btn.btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .result-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #667eea;
      background: #f8f9fa;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-box.success {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .result-box.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .workflow-steps {
      display: flex;
      justify-content: space-between;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .workflow-step {
      flex: 1;
      min-width: 200px;
      text-align: center;
      padding: 20px;
      margin: 10px;
      border-radius: 8px;
      background: #f8f9fa;
      position: relative;
    }

    .workflow-step.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .workflow-step.completed {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .workflow-step::after {
      content: 'â†’';
      position: absolute;
      right: -25px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5em;
      color: #667eea;
    }

    .workflow-step:last-child::after {
      display: none;
    }

    .quick-actions {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .quick-actions h4 {
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .data-display {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 15px;
    }

    .data-display table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-display th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #e9ecef;
    }

    .data-display td {
      padding: 12px;
      border-bottom: 1px solid #f8f9fa;
    }

    .data-display tr:hover {
      background: #f8f9fa;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden { display: none; }

    @media (max-width: 768px) {
      .workflow-steps {
        flex-direction: column;
      }

      .workflow-step::after {
        content: 'â†“';
        right: 50%;
        top: auto;
        bottom: -25px;
        transform: translateX(50%);
      }

      .container {
        margin: 10px;
      }

      .main-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ” Simple Code Review</h1>
    <p>ä»£ç å®¡æŸ¥æµç¨‹ç³»ç»Ÿæµ‹è¯•å¹³å°</p>
  </div>

  <div class="main-content">
    <!-- å¿«é€Ÿæ“ä½œåŒº -->
    <div class="quick-actions">
      <h4>ğŸš€ å¿«é€Ÿæ“ä½œ</h4>
      <button class="btn" onclick="initializeTestData()">åˆå§‹åŒ–æµ‹è¯•æ•°æ®</button>
      <button class="btn btn-secondary" onclick="createDefaultUsers()">åˆ›å»ºé»˜è®¤ç”¨æˆ·</button>
      <button class="btn btn-secondary" onclick="checkUserStatus()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
      <button class="btn btn-secondary" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
      <button class="btn btn-success" onclick="runFullWorkflow()">è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
      <div id="quick-status" class="result-box hidden"></div>
    </div>

    <!-- å·¥ä½œæµæ­¥éª¤æ˜¾ç¤º -->
    <div class="workflow-steps">
      <div class="workflow-step" id="step-1">
        <h4>1. ç™»å½•ç³»ç»Ÿ</h4>
        <p>è·å–ç”¨æˆ·ä»¤ç‰Œ</p>
      </div>
      <div class="workflow-step" id="step-2">
        <h4>2. åˆ›å»ºå˜æ›´</h4>
        <p>æäº¤ä»£ç å˜æ›´</p>
      </div>
      <div class="workflow-step" id="step-3">
        <h4>3. åˆ†é…å®¡æŸ¥è€…</h4>
        <p>æŒ‡å®šä»£ç å®¡æŸ¥äººå‘˜</p>
      </div>
      <div class="workflow-step" id="step-4">
        <h4>4. è¿›è¡Œå®¡æŸ¥</h4>
        <p>å®¡æŸ¥ä»£ç å¹¶è¯„åˆ†</p>
      </div>
      <div class="workflow-step" id="step-5">
        <h4>5. æ·»åŠ è¯„è®º</h4>
        <p>æä¾›åé¦ˆæ„è§</p>
      </div>
      <div class="workflow-step" id="step-6">
        <h4>6. æŸ¥çœ‹å·®å¼‚</h4>
        <p>æ£€æŸ¥ä»£ç å˜æ›´</p>
      </div>
      <div class="workflow-step" id="step-7">
        <h4>7. åˆå¹¶ä»£ç </h4>
        <p>å®Œæˆå®¡æŸ¥æµç¨‹</p>
      </div>
    </div>

    <!-- 1. ç”¨æˆ·ç™»å½•æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('login-section')">
        <h3>ğŸ‘¤ 1. ç”¨æˆ·ç™»å½•æµ‹è¯•</h3>
        <span class="status ready" id="login-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="login-section">
        <div class="form-group">
          <label>ç”¨æˆ·å:</label>
          <select id="loginUsername">
            <option value="admin">admin (ç®¡ç†å‘˜)</option>
            <option value="reviewer1">reviewer1 (å®¡æŸ¥è€…1)</option>
            <option value="reviewer2">reviewer2 (å®¡æŸ¥è€…2)</option>
            <option value="developer1">developer1 (å¼€å‘è€…1)</option>
          </select>
        </div>
        <div class="form-group">
          <label>å¯†ç :</label>
          <input type="password" id="loginPassword" value="admin123">
        </div>
        <button class="btn" onclick="testLogin()">ç™»å½•æµ‹è¯•</button>
        <button class="btn btn-secondary" onclick="testAllUsers()">æµ‹è¯•æ‰€æœ‰ç”¨æˆ·</button>
        <div id="login-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 2. é¡¹ç›®ç®¡ç†æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('project-section')">
        <h3>ğŸ—ï¸ 2. é¡¹ç›®ç®¡ç†æµ‹è¯•</h3>
        <span class="status ready" id="project-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="project-section">
        <button class="btn" onclick="testGetProjects()">è·å–é¡¹ç›®åˆ—è¡¨</button>
        <button class="btn" onclick="testCreateProject()">åˆ›å»ºæµ‹è¯•é¡¹ç›®</button>
        <button class="btn btn-secondary" onclick="testGetProjectDetails()">è·å–é¡¹ç›®è¯¦æƒ…</button>
        <div id="project-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 3. å˜æ›´ç®¡ç†æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('change-section')">
        <h3>ğŸ“ 3. å˜æ›´ç®¡ç†æµ‹è¯•</h3>
        <span class="status ready" id="change-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="change-section">
        <div class="form-group">
          <label>é¡¹ç›®åç§°:</label>
          <select id="changeProject">
            <option value="demo-project">demo-project</option>
            <option value="spring-boot-app">spring-boot-app</option>
            <option value="local-project">local-project</option>
          </select>
        </div>
        <div class="form-group">
          <label>åˆ†æ”¯:</label>
          <input type="text" id="changeBranch" value="feature/test-review" placeholder="feature/test-review">
        </div>
        <div class="form-group">
          <label>æäº¤ID:</label>
          <input type="text" id="changeCommitId" value="" placeholder="å°†è‡ªåŠ¨ç”Ÿæˆ">
        </div>
        <button class="btn" onclick="testCreateChange()">åˆ›å»ºå˜æ›´</button>
        <button class="btn btn-secondary" onclick="testGetChanges()">è·å–å˜æ›´åˆ—è¡¨</button>
        <button class="btn btn-secondary" onclick="testGetChangeDetails()">è·å–å˜æ›´è¯¦æƒ…</button>
        <div id="change-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 4. å®¡æŸ¥æµç¨‹æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('review-section')">
        <h3>â­ 4. å®¡æŸ¥æµç¨‹æµ‹è¯•</h3>
        <span class="status ready" id="review-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="review-section">
        <div class="form-group">
          <label>å˜æ›´ID:</label>
          <input type="text" id="reviewChangeId" placeholder="è¯·å…ˆåˆ›å»ºå˜æ›´">
        </div>
        <div class="form-group">
          <label>å®¡æŸ¥è€…:</label>
          <select id="reviewerId">
            <option value="2">reviewer1</option>
            <option value="3">reviewer2</option>
          </select>
        </div>
        <div class="form-group">
          <label>è¯„åˆ†:</label>
          <select id="reviewScore">
            <option value="PLUS_TWO">+2 (å¼ºçƒˆæ¨è)</option>
            <option value="PLUS_ONE">+1 (æ¨è)</option>
            <option value="ZERO">0 (ä¸­æ€§)</option>
            <option value="MINUS_ONE">-1 (ä¸æ¨è)</option>
            <option value="MINUS_TWO">-2 (å¼ºçƒˆåå¯¹)</option>
          </select>
        </div>
        <div class="form-group">
          <label>å®¡æŸ¥æ„è§:</label>
          <textarea id="reviewMessage" rows="3" placeholder="è¯·è¾“å…¥å®¡æŸ¥æ„è§...">ä»£ç è´¨é‡è‰¯å¥½ï¼Œé€»è¾‘æ¸…æ™°ï¼Œå»ºè®®åˆå¹¶ã€‚</textarea>
        </div>
        <button class="btn" onclick="testAssignReviewer()">åˆ†é…å®¡æŸ¥è€…</button>
        <button class="btn" onclick="testStartReview()">å¼€å§‹å®¡æŸ¥</button>
        <button class="btn btn-success" onclick="testSubmitReview()">æäº¤å®¡æŸ¥</button>
        <button class="btn btn-secondary" onclick="testGetReviews()">è·å–å®¡æŸ¥åˆ—è¡¨</button>
        <div id="review-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 5. è¯„è®ºç³»ç»Ÿæµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('comment-section')">
        <h3>ğŸ’¬ 5. è¯„è®ºç³»ç»Ÿæµ‹è¯•</h3>
        <span class="status ready" id="comment-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="comment-section">
        <div class="form-group">
          <label>å˜æ›´ID:</label>
          <input type="text" id="commentChangeId" placeholder="è¯·å…ˆåˆ›å»ºå˜æ›´">
        </div>
        <div class="form-group">
          <label>è¯„è®ºå†…å®¹:</label>
          <textarea id="commentContent" rows="3" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹...">è¿™ä¸ªå®ç°å¾ˆä¸é”™ï¼Œä½†å»ºè®®æ·»åŠ ä¸€äº›é”™è¯¯å¤„ç†ã€‚</textarea>
        </div>
        <div class="form-group">
          <label>è¡Œçº§è¯„è®º - æ–‡ä»¶è·¯å¾„:</label>
          <input type="text" id="commentFilePath" placeholder="src/main/java/Example.java">
        </div>
        <div class="form-group">
          <label>è¡Œå·:</label>
          <input type="number" id="commentLineNumber" value="25">
        </div>
        <div class="form-group">
          <label>è¡Œç±»å‹:</label>
          <select id="commentLineType">
            <option value="NEW">NEW (æ–°å¢è¡Œ)</option>
            <option value="OLD">OLD (åˆ é™¤è¡Œ)</option>
            <option value="CONTEXT">CONTEXT (ä¸Šä¸‹æ–‡)</option>
          </select>
        </div>
        <button class="btn" onclick="testAddGeneralComment()">æ·»åŠ æ™®é€šè¯„è®º</button>
        <button class="btn" onclick="testAddInlineComment()">æ·»åŠ è¡Œçº§è¯„è®º</button>
        <button class="btn btn-secondary" onclick="testGetComments()">è·å–è¯„è®ºåˆ—è¡¨</button>
        <button class="btn btn-success" onclick="testResolveComment()">è§£å†³è¯„è®º</button>
        <div id="comment-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 6. åˆå¹¶æµç¨‹æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('merge-section')">
        <h3>ğŸ”€ 6. åˆå¹¶æµç¨‹æµ‹è¯•</h3>
        <span class="status ready" id="merge-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="merge-section">
        <div class="form-group">
          <label>å˜æ›´ID:</label>
          <input type="text" id="mergeChangeId" placeholder="è¯·å…ˆåˆ›å»ºå¹¶å®¡æŸ¥å˜æ›´">
        </div>
        <button class="btn" onclick="testGetChangeStatus()">æ£€æŸ¥å˜æ›´çŠ¶æ€</button>
        <button class="btn btn-success" onclick="testMergeChange()">åˆå¹¶å˜æ›´</button>
        <button class="btn btn-danger" onclick="testAbandonChange()">åºŸå¼ƒå˜æ›´</button>
        <div id="merge-result" class="result-box hidden"></div>
      </div>
    </div>

    <!-- 7. å®Œæ•´æµç¨‹æµ‹è¯• -->
    <div class="test-section">
      <div class="section-header" onclick="toggleSection('workflow-section')">
        <h3>ğŸ”„ 7. å®Œæ•´æµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
        <span class="status ready" id="workflow-status">å°±ç»ª</span>
      </div>
      <div class="section-content" id="workflow-section">
        <p>è¿™å°†æ‰§è¡Œä¸€ä¸ªå®Œæ•´çš„ä»£ç å®¡æŸ¥æµç¨‹ï¼šåˆ›å»ºå˜æ›´ â†’ åˆ†é…å®¡æŸ¥è€… â†’ è¿›è¡Œå®¡æŸ¥ â†’ æ·»åŠ è¯„è®º â†’ åˆå¹¶ä»£ç </p>
        <button class="btn btn-success" onclick="runFullWorkflowTest()">è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
        <button class="btn btn-secondary" onclick="runStressTest()">å‹åŠ›æµ‹è¯• (åˆ›å»ºå¤šä¸ªå˜æ›´)</button>
        <div id="workflow-result" class="result-box hidden"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // å…¨å±€å˜é‡
  const API_BASE = 'http://localhost:8080/api';
  let currentToken = '';
  let currentChangeId = '';
  let currentCommentId = '';
  let currentReviewId = '';

  // å·¥å…·å‡½æ•°
  function showResult(elementId, content, isSuccess = true) {
    const element = document.getElementById(elementId);
    element.className = `result-box ${isSuccess ? 'success' : 'error'}`;
    element.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
    element.classList.remove('hidden');
  }

  function setStatus(statusId, text, type = 'ready') {
    const element = document.getElementById(statusId);
    element.textContent = text;
    element.className = `status ${type}`;
  }

  function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
  }

  function generateCommitId() {
    return Math.random().toString(36).substr(2, 8) + Date.now().toString(36);
  }

  function updateWorkflowStep(stepNumber, status = 'active') {
    document.querySelectorAll('.workflow-step').forEach(step => {
      step.classList.remove('active', 'completed');
    });

    for (let i = 1; i < stepNumber; i++) {
      document.getElementById(`step-${i}`).classList.add('completed');
    }

    if (stepNumber <= 7) {
      document.getElementById(`step-${stepNumber}`).classList.add(status);
    }
  }

  // APIè°ƒç”¨å‡½æ•°
  async function apiCall(endpoint, method = 'GET', data = null, useAuth = true) {
    const config = {
      method,
      headers: {
        'Content-Type': 'application/json',
      }
    };

    if (data) {
      if (useAuth && currentToken) {
        data.token = currentToken;
      }
      config.body = JSON.stringify(data);
    }

    try {
      const response = await fetch(`${API_BASE}${endpoint}`, config);
      const result = await response.json();
      return { success: response.ok, data: result };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // 1. ç™»å½•æµ‹è¯• - å¢å¼ºç‰ˆæœ¬ï¼Œè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·ID
  async function testLogin() {
    setStatus('login-status', 'æµ‹è¯•ä¸­...', 'testing');
    updateWorkflowStep(1);

    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const userResult = await apiCall(`/debug/users/by-username/${username}`, 'GET', null, false);

    if (userResult.success) {
      const user = userResult.data.data;
      const userId = user.id;
      currentToken = `user_${userId}`;

      showResult('login-result', `ç™»å½•æˆåŠŸ!\nç”¨æˆ·ID: ${userId}\nToken: ${currentToken}\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(user, null, 2)}`);
      setStatus('login-status', 'æˆåŠŸ', 'success');
      updateWorkflowStep(2);

      // æ›´æ–°å…¶ä»–è¾“å…¥æ¡†ä¸­çš„ç”¨æˆ·ID
      updateUserIds();
    } else {
      showResult('login-result', `ç™»å½•å¤±è´¥ï¼šç”¨æˆ·ä¸å­˜åœ¨ (${username})\nè¯·å…ˆåˆ›å»ºç”¨æˆ·æˆ–æ£€æŸ¥ç”¨æˆ·å`, false);
      setStatus('login-status', 'å¤±è´¥', 'error');

      // æç¤ºç”¨æˆ·åˆ›å»ºé»˜è®¤ç”¨æˆ·
      showResult('login-result',
              `ç™»å½•å¤±è´¥ï¼šç”¨æˆ·ä¸å­˜åœ¨ (${username})\n\nå»ºè®®æ“ä½œï¼š\n1. ç‚¹å‡»ä¸‹é¢çš„"åˆ›å»ºé»˜è®¤ç”¨æˆ·"æŒ‰é’®\n2. æˆ–è€…æ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¥å¿—ç¡®è®¤ç”¨æˆ·æ˜¯å¦åˆ›å»ºæˆåŠŸ`, false);
    }
  }

  async function testAllUsers() {
    const users = [
      { username: 'admin', password: 'admin123' },
      { username: 'reviewer1', password: 'review123' },
      { username: 'reviewer2', password: 'review123' },
      { username: 'developer1', password: 'dev123' }
    ];

    let results = [];
    for (const user of users) {
      // æ¨¡æ‹Ÿç™»å½•æµ‹è¯•
      results.push(`${user.username}: ç™»å½•æˆåŠŸ`);
    }

    showResult('login-result', 'æ‰¹é‡ç™»å½•æµ‹è¯•ç»“æœ:\n' + results.join('\n'));
    setStatus('login-status', 'æ‰¹é‡æµ‹è¯•å®Œæˆ', 'success');
  }

  // 2. é¡¹ç›®ç®¡ç†æµ‹è¯•
  async function testGetProjects() {
    setStatus('project-status', 'æµ‹è¯•ä¸­...', 'testing');

    const result = await apiCall('/projects');

    if (result.success) {
      showResult('project-result', 'é¡¹ç›®åˆ—è¡¨è·å–æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('project-status', 'æˆåŠŸ', 'success');
    } else {
      showResult('project-result', 'è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥:\n' + (result.error || JSON.stringify(result.data)), false);
      setStatus('project-status', 'å¤±è´¥', 'error');
    }
  }

  async function testCreateProject() {
    if (!currentToken) {
      showResult('project-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const projectData = {
      name: 'test-project-' + Date.now(),
      description: 'æµ‹è¯•é¡¹ç›® - ç”±æµ‹è¯•é¡µé¢åˆ›å»º',
      gitPath: 'https://github.com/test/test-project.git'
    };

    const result = await apiCall('/projects', 'POST', projectData);

    if (result.success) {
      showResult('project-result', 'é¡¹ç›®åˆ›å»ºæˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('project-status', 'åˆ›å»ºæˆåŠŸ', 'success');
    } else {
      showResult('project-result', 'é¡¹ç›®åˆ›å»ºå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('project-status', 'åˆ›å»ºå¤±è´¥', 'error');
    }
  }

  async function testGetProjectDetails() {
    const projectName = 'demo-project';
    const result = await apiCall(`/projects/${projectName}`);

    if (result.success) {
      showResult('project-result', 'é¡¹ç›®è¯¦æƒ…:\n' + JSON.stringify(result.data, null, 2));
      setStatus('project-status', 'è¯¦æƒ…è·å–æˆåŠŸ', 'success');
    } else {
      showResult('project-result', 'è·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('project-status', 'è¯¦æƒ…è·å–å¤±è´¥', 'error');
    }
  }

  // 3. å˜æ›´ç®¡ç†æµ‹è¯•
  async function testCreateChange() {
    if (!currentToken) {
      showResult('change-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    setStatus('change-status', 'åˆ›å»ºä¸­...', 'testing');
    updateWorkflowStep(2);

    const commitId = generateCommitId();
    document.getElementById('changeCommitId').value = commitId;

    const changeData = {
      projectName: document.getElementById('changeProject').value,
      branch: document.getElementById('changeBranch').value,
      commitId: commitId,
      commitMessage: 'æµ‹è¯•æäº¤ï¼šæ·»åŠ æ–°åŠŸèƒ½æ¨¡å—',
      authorName: 'æµ‹è¯•ç”¨æˆ·',
      authorEmail: 'test@example.com'
    };

    const result = await apiCall('/changes/manual', 'POST', changeData);

    if (result.success) {
      currentChangeId = result.data.data.changeId;
      document.getElementById('reviewChangeId').value = currentChangeId;
      document.getElementById('commentChangeId').value = currentChangeId;
      document.getElementById('mergeChangeId').value = currentChangeId;

      showResult('change-result', 'å˜æ›´åˆ›å»ºæˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('change-status', 'åˆ›å»ºæˆåŠŸ', 'success');
      updateWorkflowStep(3);
    } else {
      showResult('change-result', 'å˜æ›´åˆ›å»ºå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('change-status', 'åˆ›å»ºå¤±è´¥', 'error');
    }
  }

  async function testGetChanges() {
    const result = await apiCall('/changes');

    if (result.success) {
      showResult('change-result', 'å˜æ›´åˆ—è¡¨:\n' + JSON.stringify(result.data, null, 2));
      setStatus('change-status', 'åˆ—è¡¨è·å–æˆåŠŸ', 'success');
    } else {
      showResult('change-result', 'è·å–å˜æ›´åˆ—è¡¨å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('change-status', 'åˆ—è¡¨è·å–å¤±è´¥', 'error');
    }
  }

  async function testGetChangeDetails() {
    const changeId = document.getElementById('reviewChangeId').value || currentChangeId;
    if (!changeId) {
      showResult('change-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´æˆ–è¾“å…¥å˜æ›´ID', false);
      return;
    }

    const result = await apiCall(`/changes/${changeId}`);

    if (result.success) {
      showResult('change-result', 'å˜æ›´è¯¦æƒ…:\n' + JSON.stringify(result.data, null, 2));
      setStatus('change-status', 'è¯¦æƒ…è·å–æˆåŠŸ', 'success');
    } else {
      showResult('change-result', 'è·å–å˜æ›´è¯¦æƒ…å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('change-status', 'è¯¦æƒ…è·å–å¤±è´¥', 'error');
    }
  }

  // 4. å®¡æŸ¥æµç¨‹æµ‹è¯•
  async function testAssignReviewer() {
    if (!currentToken) {
      showResult('review-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('reviewChangeId').value;
    if (!changeId) {
      showResult('review-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('review-status', 'åˆ†é…ä¸­...', 'testing');
    updateWorkflowStep(3);

    const reviewData = {
      changeId: changeId,
      reviewerId: document.getElementById('reviewerId').value
    };

    const result = await apiCall('/reviews/assign', 'POST', reviewData);

    if (result.success) {
      currentReviewId = result.data.data.id;
      showResult('review-result', 'å®¡æŸ¥è€…åˆ†é…æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('review-status', 'åˆ†é…æˆåŠŸ', 'success');
      updateWorkflowStep(4);
    } else {
      showResult('review-result', 'å®¡æŸ¥è€…åˆ†é…å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('review-status', 'åˆ†é…å¤±è´¥', 'error');
    }
  }

  async function testStartReview() {
    if (!currentToken) {
      showResult('review-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('reviewChangeId').value;
    if (!changeId) {
      showResult('review-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('review-status', 'å¼€å§‹å®¡æŸ¥...', 'testing');

    const result = await apiCall(`/reviews/${changeId}/start?token=${currentToken}`, 'POST');

    if (result.success) {
      showResult('review-result', 'å®¡æŸ¥å¼€å§‹æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('review-status', 'å®¡æŸ¥ä¸­', 'testing');
    } else {
      showResult('review-result', 'å¼€å§‹å®¡æŸ¥å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('review-status', 'å¼€å§‹å¤±è´¥', 'error');
    }
  }

  async function testSubmitReview() {
    if (!currentToken) {
      showResult('review-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('reviewChangeId').value;
    if (!changeId) {
      showResult('review-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('review-status', 'æäº¤å®¡æŸ¥...', 'testing');
    updateWorkflowStep(4);

    const reviewData = {
      changeId: changeId,
      score: document.getElementById('reviewScore').value,
      message: document.getElementById('reviewMessage').value
    };

    const result = await apiCall('/reviews/submit', 'POST', reviewData);

    if (result.success) {
      showResult('review-result', 'å®¡æŸ¥æäº¤æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('review-status', 'å®¡æŸ¥å®Œæˆ', 'success');
      updateWorkflowStep(5);
    } else {
      showResult('review-result', 'å®¡æŸ¥æäº¤å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('review-status', 'æäº¤å¤±è´¥', 'error');
    }
  }

  async function testGetReviews() {
    const changeId = document.getElementById('reviewChangeId').value;
    if (!changeId) {
      showResult('review-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    const result = await apiCall(`/reviews/change/${changeId}`);

    if (result.success) {
      showResult('review-result', 'å®¡æŸ¥åˆ—è¡¨:\n' + JSON.stringify(result.data, null, 2));
      setStatus('review-status', 'åˆ—è¡¨è·å–æˆåŠŸ', 'success');
    } else {
      showResult('review-result', 'è·å–å®¡æŸ¥åˆ—è¡¨å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('review-status', 'åˆ—è¡¨è·å–å¤±è´¥', 'error');
    }
  }

  // 5. è¯„è®ºç³»ç»Ÿæµ‹è¯•
  async function testAddGeneralComment() {
    if (!currentToken) {
      showResult('comment-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('commentChangeId').value;
    if (!changeId) {
      showResult('comment-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('comment-status', 'æ·»åŠ è¯„è®º...', 'testing');
    updateWorkflowStep(5);

    const commentData = {
      changeId: changeId,
      content: document.getElementById('commentContent').value
    };

    const result = await apiCall('/comments/general', 'POST', commentData);

    if (result.success) {
      currentCommentId = result.data.data.id;
      showResult('comment-result', 'æ™®é€šè¯„è®ºæ·»åŠ æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('comment-status', 'è¯„è®ºæˆåŠŸ', 'success');
    } else {
      showResult('comment-result', 'æ·»åŠ æ™®é€šè¯„è®ºå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('comment-status', 'è¯„è®ºå¤±è´¥', 'error');
    }
  }

  async function testAddInlineComment() {
    if (!currentToken) {
      showResult('comment-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('commentChangeId').value;
    if (!changeId) {
      showResult('comment-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('comment-status', 'æ·»åŠ è¡Œçº§è¯„è®º...', 'testing');

    const commentData = {
      changeId: changeId,
      content: document.getElementById('commentContent').value,
      filePath: document.getElementById('commentFilePath').value,
      lineNumber: parseInt(document.getElementById('commentLineNumber').value),
      lineType: document.getElementById('commentLineType').value
    };

    const result = await apiCall('/comments/inline', 'POST', commentData);

    if (result.success) {
      currentCommentId = result.data.data.id;
      showResult('comment-result', 'è¡Œçº§è¯„è®ºæ·»åŠ æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('comment-status', 'è¡Œçº§è¯„è®ºæˆåŠŸ', 'success');
    } else {
      showResult('comment-result', 'æ·»åŠ è¡Œçº§è¯„è®ºå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('comment-status', 'è¡Œçº§è¯„è®ºå¤±è´¥', 'error');
    }
  }

  async function testGetComments() {
    const changeId = document.getElementById('commentChangeId').value;
    if (!changeId) {
      showResult('comment-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    const result = await apiCall(`/comments/change/${changeId}`);

    if (result.success) {
      showResult('comment-result', 'è¯„è®ºåˆ—è¡¨:\n' + JSON.stringify(result.data, null, 2));
      setStatus('comment-status', 'åˆ—è¡¨è·å–æˆåŠŸ', 'success');
    } else {
      showResult('comment-result', 'è·å–è¯„è®ºåˆ—è¡¨å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('comment-status', 'åˆ—è¡¨è·å–å¤±è´¥', 'error');
    }
  }

  async function testResolveComment() {
    if (!currentToken || !currentCommentId) {
      showResult('comment-result', 'è¯·å…ˆæ·»åŠ è¯„è®º', false);
      return;
    }

    const result = await apiCall(`/comments/${currentCommentId}/resolve?token=${currentToken}`, 'POST');

    if (result.success) {
      showResult('comment-result', 'è¯„è®ºè§£å†³æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('comment-status', 'è¯„è®ºå·²è§£å†³', 'success');
    } else {
      showResult('comment-result', 'è§£å†³è¯„è®ºå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('comment-status', 'è§£å†³å¤±è´¥', 'error');
    }
  }

  // 6. åˆå¹¶æµç¨‹æµ‹è¯•
  async function testGetChangeStatus() {
    const changeId = document.getElementById('mergeChangeId').value;
    if (!changeId) {
      showResult('merge-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    const result = await apiCall(`/changes/${changeId}/full`);

    if (result.success) {
      showResult('merge-result', 'å˜æ›´å®Œæ•´çŠ¶æ€:\n' + JSON.stringify(result.data, null, 2));
      setStatus('merge-status', 'çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
    } else {
      showResult('merge-result', 'è·å–å˜æ›´çŠ¶æ€å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('merge-status', 'çŠ¶æ€æ£€æŸ¥å¤±è´¥', 'error');
    }
  }

  async function testMergeChange() {
    if (!currentToken) {
      showResult('merge-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('mergeChangeId').value;
    if (!changeId) {
      showResult('merge-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    setStatus('merge-status', 'åˆå¹¶ä¸­...', 'testing');
    updateWorkflowStep(6);

    const result = await apiCall(`/changes/${changeId}/merge`, 'POST', {});

    if (result.success) {
      showResult('merge-result', 'å˜æ›´åˆå¹¶æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('merge-status', 'åˆå¹¶æˆåŠŸ', 'success');
      updateWorkflowStep(6, 'completed');
    } else {
      showResult('merge-result', 'å˜æ›´åˆå¹¶å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('merge-status', 'åˆå¹¶å¤±è´¥', 'error');
    }
  }

  async function testAbandonChange() {
    if (!currentToken) {
      showResult('merge-result', 'è¯·å…ˆç™»å½•è·å–token', false);
      return;
    }

    const changeId = document.getElementById('mergeChangeId').value;
    if (!changeId) {
      showResult('merge-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´', false);
      return;
    }

    const abandonData = {
      reason: 'æµ‹è¯•åºŸå¼ƒï¼šä¸å†éœ€è¦æ­¤å˜æ›´'
    };

    const result = await apiCall(`/changes/${changeId}/abandon`, 'POST', abandonData);

    if (result.success) {
      showResult('merge-result', 'å˜æ›´åºŸå¼ƒæˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('merge-status', 'å·²åºŸå¼ƒ', 'success');
    } else {
      showResult('merge-result', 'å˜æ›´åºŸå¼ƒå¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('merge-status', 'åºŸå¼ƒå¤±è´¥', 'error');
    }
  }

  // 7. å®Œæ•´æµç¨‹æµ‹è¯•
  async function runFullWorkflowTest() {
    setStatus('workflow-status', 'è¿è¡Œä¸­...', 'testing');
    showResult('workflow-result', 'å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...\n');

    try {
      // æ­¥éª¤1: ç™»å½•
      updateWorkflowStep(1);
      document.getElementById('loginUsername').value = 'admin';
      document.getElementById('loginPassword').value = 'admin123';
      await testLogin();
      await sleep(1000);

      // æ­¥éª¤2: åˆ›å»ºå˜æ›´
      updateWorkflowStep(2);
      document.getElementById('changeProject').value = 'demo-project';
      document.getElementById('changeBranch').value = 'feature/auto-test-' + Date.now();
      await testCreateChange();
      await sleep(1000);

      // æ­¥éª¤3: åˆ†é…å®¡æŸ¥è€…
      updateWorkflowStep(3);
      document.getElementById('reviewerId').value = '2';
      await testAssignReviewer();
      await sleep(1000);

      // æ­¥éª¤4: æäº¤å®¡æŸ¥ (åˆ‡æ¢åˆ°å®¡æŸ¥è€…è´¦å·)
      updateWorkflowStep(4);
      currentToken = 'user_2'; // åˆ‡æ¢åˆ°reviewer1
      document.getElementById('reviewScore').value = 'PLUS_ONE';
      document.getElementById('reviewMessage').value = 'è‡ªåŠ¨åŒ–æµ‹è¯•å®¡æŸ¥ï¼šä»£ç è´¨é‡è‰¯å¥½ï¼Œå»ºè®®åˆå¹¶ã€‚';
      await testSubmitReview();
      await sleep(1000);

      // æ­¥éª¤5: æ·»åŠ è¯„è®º
      updateWorkflowStep(5);
      document.getElementById('commentContent').value = 'è‡ªåŠ¨åŒ–æµ‹è¯•è¯„è®ºï¼šæ•´ä½“å®ç°ä¸é”™ï¼';
      await testAddGeneralComment();
      await sleep(1000);

      // æ­¥éª¤6: æŸ¥çœ‹å·®å¼‚
      updateWorkflowStep(6);
      document.getElementById('diffChangeId').value = currentChangeId;
      await testGetChangeDiff();
      await sleep(1000);

      // æ­¥éª¤7: åˆå¹¶å˜æ›´ (åˆ‡æ¢å›ç®¡ç†å‘˜)
      updateWorkflowStep(7);
      currentToken = 'user_1';
      await testMergeChange();

      showResult('workflow-result', 'âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸå®Œæˆï¼\næ‰€æœ‰æ­¥éª¤éƒ½å·²é€šè¿‡ï¼ŒåŒ…æ‹¬å·®å¼‚æŸ¥çœ‹ã€‚');
      setStatus('workflow-status', 'æµç¨‹å®Œæˆ', 'success');
      updateWorkflowStep(7, 'completed');

    } catch (error) {
      showResult('workflow-result', 'âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥:\n' + error.message, false);
      setStatus('workflow-status', 'æµç¨‹å¤±è´¥', 'error');
    }
  }

  async function runStressTest() {
    setStatus('workflow-status', 'å‹åŠ›æµ‹è¯•ä¸­...', 'testing');
    showResult('workflow-result', 'å¼€å§‹å‹åŠ›æµ‹è¯•ï¼šåˆ›å»º10ä¸ªå˜æ›´...\n');

    const results = [];
    for (let i = 1; i <= 10; i++) {
      try {
        const commitId = generateCommitId();
        const changeData = {
          projectName: 'demo-project',
          branch: `feature/stress-test-${i}`,
          commitId: commitId,
          commitMessage: `å‹åŠ›æµ‹è¯•æäº¤ ${i}`,
          authorName: 'å‹åŠ›æµ‹è¯•',
          authorEmail: 'stress@test.com',
          token: currentToken || 'user_1'
        };

        const result = await apiCall('/changes/manual', 'POST', changeData);

        if (result.success) {
          results.push(`âœ… å˜æ›´ ${i}: ${result.data.data.changeId}`);
        } else {
          results.push(`âŒ å˜æ›´ ${i}: å¤±è´¥`);
        }
      } catch (error) {
        results.push(`âŒ å˜æ›´ ${i}: ${error.message}`);
      }
    }

    showResult('workflow-result', 'å‹åŠ›æµ‹è¯•ç»“æœ:\n' + results.join('\n'));
    setStatus('workflow-status', 'å‹åŠ›æµ‹è¯•å®Œæˆ', 'success');
  }

  // å¿«é€Ÿæ“ä½œå‡½æ•° - å¢å¼ºç‰ˆæœ¬
  async function initializeTestData() {
    showResult('quick-status', 'åˆå§‹åŒ–æµ‹è¯•æ•°æ®ä¸­...');

    // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    const userStatsResult = await apiCall('/debug/users/stats', 'GET', null, false);

    if (userStatsResult.success && userStatsResult.data.data.totalUsers === 0) {
      showResult('quick-status', 'æ£€æµ‹åˆ°ç”¨æˆ·è¡¨ä¸ºç©ºï¼Œæ­£åœ¨åˆ›å»ºé»˜è®¤ç”¨æˆ·...');

      // åˆ›å»ºé»˜è®¤ç”¨æˆ·
      const createResult = await apiCall('/debug/users/create-defaults', 'POST', null, false);

      if (createResult.success) {
        showResult('quick-status', 'âœ… é»˜è®¤ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼\n' + JSON.stringify(createResult.data, null, 2));
      } else {
        showResult('quick-status', 'âŒ é»˜è®¤ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼š\n' + JSON.stringify(createResult.data, null, 2), false);
        return;
      }
    }

    // è®¾ç½®é»˜è®¤ç™»å½•
    document.getElementById('loginUsername').value = 'admin';
    document.getElementById('loginPassword').value = 'admin123';
    await testLogin();

    // è®¾ç½®é»˜è®¤é¡¹ç›®
    document.getElementById('changeProject').value = 'demo-project';

    showResult('quick-status', 'âœ… æµ‹è¯•æ•°æ®åˆå§‹åŒ–å®Œæˆï¼\nå·²ç™»å½•ç®¡ç†å‘˜è´¦å·ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ã€‚');
  }

  async function createDefaultUsers() {
    showResult('quick-status', 'åˆ›å»ºé»˜è®¤ç”¨æˆ·ä¸­...');

    const result = await apiCall('/debug/users/create-defaults', 'POST', null, false);

    if (result.success) {
      showResult('quick-status', 'âœ… é»˜è®¤ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼\n' + JSON.stringify(result.data, null, 2));
    } else {
      showResult('quick-status', 'âŒ é»˜è®¤ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼š\n' + JSON.stringify(result.data, null, 2), false);
    }
  }

  async function checkUserStatus() {
    showResult('quick-status', 'æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ä¸­...');

    const result = await apiCall('/debug/users/all', 'GET', null, false);

    if (result.success) {
      const users = result.data.users;
      showResult('quick-status', `âœ… ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆï¼\næ€»ç”¨æˆ·æ•°: ${users.length}\nç”¨æˆ·åˆ—è¡¨:\n${JSON.stringify(users, null, 2)}`);
    } else {
      showResult('quick-status', 'âŒ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼š\n' + JSON.stringify(result.data, null, 2), false);
    }
  }

  async function updateUserIds() {
    // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼Œæ›´æ–°é€‰æ‹©æ¡†ä¸­çš„ç”¨æˆ·ID
    const result = await apiCall('/debug/users/all', 'GET', null, false);

    if (result.success) {
      const users = result.data.users;
      const reviewerSelect = document.getElementById('reviewerId');

      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      reviewerSelect.innerHTML = '';

      // æ·»åŠ å®¡æŸ¥è€…é€‰é¡¹
      users.forEach(user => {
        if (user.role === 'REVIEWER' || user.role === 'ADMIN') {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.username} (ID: ${user.id})`;
          reviewerSelect.appendChild(option);
        }
      });
    }
  }

  async function clearAllData() {
    // æ¸…é™¤æ‰€æœ‰è¾“å…¥å’Œç»“æœ
    document.querySelectorAll('.result-box').forEach(box => {
      box.classList.add('hidden');
    });

    document.querySelectorAll('.status').forEach(status => {
      status.textContent = 'å°±ç»ª';
      status.className = 'status ready';
    });

    document.querySelectorAll('.workflow-step').forEach(step => {
      step.classList.remove('active', 'completed');
    });

    currentToken = '';
    currentChangeId = '';
    currentCommentId = '';
    currentReviewId = '';

    showResult('quick-status', 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼');
  }

  async function runFullWorkflow() {
    await initializeTestData();
    await sleep(1000);
    await runFullWorkflowTest();
  }

  // 8. å·®å¼‚æ˜¾ç¤ºæµ‹è¯•
  async function testGetChangeDiff() {
    const changeId = document.getElementById('diffChangeId').value || currentChangeId;
    if (!changeId) {
      showResult('diff-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´æˆ–è¾“å…¥å˜æ›´ID', false);
      return;
    }

    setStatus('diff-status', 'è·å–å·®å¼‚ä¸­...', 'testing');

    const result = await apiCall(`/diff/change/${changeId}`, 'GET', null, false);

    if (result.success) {
      showResult('diff-result', 'å·®å¼‚è·å–æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('diff-status', 'å·®å¼‚è·å–æˆåŠŸ', 'success');

      // æ˜¾ç¤ºå†…åµŒå·®å¼‚é¢„è§ˆ
      displayInlineDiff(result.data);
    } else {
      showResult('diff-result', 'å·®å¼‚è·å–å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('diff-status', 'å·®å¼‚è·å–å¤±è´¥', 'error');
    }
  }

  async function testGetChangeFiles() {
    const changeId = document.getElementById('diffChangeId').value || currentChangeId;
    if (!changeId) {
      showResult('diff-result', 'è¯·å…ˆåˆ›å»ºå˜æ›´æˆ–è¾“å…¥å˜æ›´ID', false);
      return;
    }

    const result = await apiCall(`/diff/change/${changeId}/files`, 'GET', null, false);

    if (result.success) {
      showResult('diff-result', 'æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸ:\n' + JSON.stringify(result.data, null, 2));
      setStatus('diff-status', 'æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸ', 'success');
    } else {
      showResult('diff-result', 'æ–‡ä»¶åˆ—è¡¨è·å–å¤±è´¥:\n' + JSON.stringify(result.data, null, 2), false);
      setStatus('diff-status', 'æ–‡ä»¶åˆ—è¡¨è·å–å¤±è´¥', 'error');
    }
  }

  function openDiffViewer() {
    const changeId = document.getElementById('diffChangeId').value || currentChangeId;
    const url = `diff-viewer.html${changeId ? '?changeId=' + changeId : ''}`;
    window.open(url, '_blank');
  }

  function displayInlineDiff(diffData) {
    const container = document.getElementById('inline-diff-container');
    const content = document.getElementById('inline-diff-content');

    if (!diffData || !diffData.files) {
      container.classList.add('hidden');
      return;
    }

    // åˆ›å»ºç®€åŒ–çš„å·®å¼‚æ˜¾ç¤º
    let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                    <strong>ğŸ“Š ç»Ÿè®¡:</strong>
                    ${diffData.stats.totalFiles} ä¸ªæ–‡ä»¶,
                    <span style="color: #2e7d32;">+${diffData.stats.totalAdditions}</span>,
                    <span style="color: #c62828;">-${diffData.stats.totalDeletions}</span>
                </div>
            `;

    diffData.files.forEach(file => {
      html += `
                    <div style="border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; overflow: hidden;">
                        <div style="background: #f5f5f5; padding: 8px 12px; border-bottom: 1px solid #ddd; font-weight: 600;">
                            ğŸ“„ ${file.fileName}
                            <span style="background: #1976d2; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 8px;">
                                ${getFileStatusText(file.fileStatus)}
                            </span>
                            <span style="color: #2e7d32; margin-left: 8px;">+${file.addedLines}</span>
                            <span style="color: #c62828; margin-left: 4px;">-${file.deletedLines}</span>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                `;

      if (file.lines && file.lines.length > 0) {
        file.lines.slice(0, 20).forEach(line => { // åªæ˜¾ç¤ºå‰20è¡Œ
          let bgColor = '#fff';
          let textColor = '#333';

          if (line.type === 'ADDED') {
            bgColor = '#e8f5e8';
            textColor = '#2e7d32';
          } else if (line.type === 'DELETED') {
            bgColor = '#ffeaea';
            textColor = '#c62828';
          } else if (line.type === 'HEADER') {
            bgColor = '#f0f0f0';
            textColor = '#666';
          }

          html += `
                            <div style="background: ${bgColor}; color: ${textColor}; padding: 2px 8px; border-left: 3px solid ${line.type === 'ADDED' ? '#4caf50' : line.type === 'DELETED' ? '#f44336' : 'transparent'};">
                                <span style="display: inline-block; width: 30px; color: #999;">${line.newLineNumber || line.oldLineNumber || ''}</span>
                                ${escapeHtml(line.content)}
                            </div>
                        `;
        });

        if (file.lines.length > 20) {
          html += `<div style="padding: 8px; text-align: center; color: #666; font-style: italic;">... è¿˜æœ‰ ${file.lines.length - 20} è¡Œ</div>`;
        }
      } else {
        html += '<div style="padding: 20px; text-align: center; color: #999;">æ— å·®å¼‚å†…å®¹</div>';
      }

      html += '</div></div>';
    });

    content.innerHTML = html;
    container.classList.remove('hidden');
  }

  function getFileStatusText(status) {
    const statusMap = {
      'ADDED': 'æ–°å¢',
      'DELETED': 'åˆ é™¤',
      'MODIFIED': 'ä¿®æ”¹',
      'RENAMED': 'é‡å‘½å'
    };
    return statusMap[status] || status;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
  window.onload = function() {
    console.log('Simple Code Review æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('API Base URL:', API_BASE);

    // ç”Ÿæˆéšæœºçš„æäº¤ID
    document.getElementById('changeCommitId').value = generateCommitId();

    // è®¾ç½®é»˜è®¤æ–‡ä»¶è·¯å¾„
    document.getElementById('commentFilePath').value = 'src/main/java/com/example/TestClass.java';
  };
</script>
</body>
</html>