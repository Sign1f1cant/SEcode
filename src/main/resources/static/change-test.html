<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å˜æ›´ç®¡ç†æµ‹è¯• V2</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 6px; }
        button { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #212529; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        input, textarea { width: 100%; padding: 6px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .change-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff; }
        .status { padding: 2px 6px; border-radius: 10px; font-size: 12px; color: white; }
        .status-open { background: #007bff; }
        .status-merged { background: #28a745; }
        .status-abandoned { background: #dc3545; }
    </style>
</head>
<body>
<h1>ğŸ”„ å˜æ›´ç®¡ç†æµ‹è¯• V2</h1>

<!-- ç”¨æˆ·çŠ¶æ€ -->
<div class="section">
    <h3>ğŸ‘¤ ç”¨æˆ·çŠ¶æ€</h3>
    <div id="userInfo">æœªç™»å½•</div>
    <button onclick="smartLogin()">æ™ºèƒ½ç™»å½•</button>
</div>

<!-- å®Œæ•´æµç¨‹æµ‹è¯• -->
<div class="section">
    <h3>ğŸš€ å®Œæ•´æµç¨‹æµ‹è¯•</h3>
    <button onclick="runFullTest()" class="success">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <button onclick="setupTestData()" class="warning">å‡†å¤‡æµ‹è¯•æ•°æ®</button>
    <button onclick="viewAllData()">æŸ¥çœ‹æ‰€æœ‰æ•°æ®</button>
</div>

<!-- æ‰‹åŠ¨æ“ä½œ -->
<div class="section">
    <h3>ğŸ”§ æ‰‹åŠ¨æ“ä½œ</h3>
    <button onclick="createTestProject()">åˆ›å»ºæµ‹è¯•é¡¹ç›®</button>
    <button onclick="createTestChange()">åˆ›å»ºæµ‹è¯•å˜æ›´</button>
    <button onclick="getAllChanges()">è·å–å˜æ›´åˆ—è¡¨</button>
</div>

<!-- å˜æ›´åˆ—è¡¨ -->
<div class="section">
    <h3>ğŸ“‹ å˜æ›´åˆ—è¡¨</h3>
    <div id="changesList">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®</div>
</div>

<!-- æ—¥å¿— -->
<div class="section">
    <h3>ğŸ“Š æ“ä½œæ—¥å¿—</h3>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <div id="log" class="result" style="height: 200px;"></div>
</div>

<script>
    const API = 'http://localhost:8080/api';
    let token = localStorage.getItem('userToken');
    let user = null;

    function log(msg) {
        const logDiv = document.getElementById('log');
        logDiv.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
    }

    function clearLog() {
        document.getElementById('log').textContent = '';
    }

    // æ™ºèƒ½ç™»å½•ï¼šå…ˆå°è¯•ç™»å½•ï¼Œå¤±è´¥åˆ™æ³¨å†Œåç™»å½•
    async function smartLogin() {
        try {
            log('å¼€å§‹æ™ºèƒ½ç™»å½•...');

            // 1. å°è¯•ç™»å½•ç°æœ‰ç”¨æˆ·
            let res = await fetch(`${API}/users/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usernameOrEmail: 'testuser1', password: '123456' })
            });
            let data = await res.json();

            if (data.success) {
                token = data.data.token;
                user = data.data;
                localStorage.setItem('userToken', token);
                document.getElementById('userInfo').textContent = `${user.displayName} - ${token}`;
                log('âœ… ç™»å½•æˆåŠŸ');
                return true;
            }

            // 2. ç™»å½•å¤±è´¥ï¼Œå°è¯•æ³¨å†Œ
            log('ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ³¨å†Œæ–°ç”¨æˆ·...');
            res = await fetch(`${API}/users/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: 'testuser1',
                    email: 'test1@example.com',
                    password: '123456',
                    displayName: 'æµ‹è¯•ç”¨æˆ·1'
                })
            });
            data = await res.json();

            if (!data.success) {
                log('âŒ æ³¨å†Œå¤±è´¥: ' + data.error);
                return false;
            }

            log('âœ… æ³¨å†ŒæˆåŠŸï¼Œç°åœ¨ç™»å½•...');

            // 3. æ³¨å†ŒæˆåŠŸåç™»å½•
            res = await fetch(`${API}/users/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usernameOrEmail: 'testuser1', password: '123456' })
            });
            data = await res.json();

            if (data.success) {
                token = data.data.token;
                user = data.data;
                localStorage.setItem('userToken', token);
                document.getElementById('userInfo').textContent = `${user.displayName} - ${token}`;
                log('âœ… ç™»å½•æˆåŠŸ');
                return true;
            } else {
                log('âŒ æ³¨å†Œåç™»å½•å¤±è´¥: ' + data.error);
                return false;
            }
        } catch (e) {
            log('âŒ ç™»å½•è¿‡ç¨‹å‡ºé”™: ' + e.message);
            return false;
        }
    }

    // åˆ›å»ºæµ‹è¯•é¡¹ç›®
    async function createTestProject() {
        if (!token) {
            log('âŒ è¯·å…ˆç™»å½•');
            return false;
        }

        try {
            log('åˆ›å»ºæµ‹è¯•é¡¹ç›®...');
            const res = await fetch(`${API}/projects`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: 'my-test-project',
                    description: 'å˜æ›´ç®¡ç†æµ‹è¯•é¡¹ç›®',
                    gitPath: 'https://github.com/octocat/Hello-World.git',
                    token: token
                })
            });
            const data = await res.json();

            if (data.success) {
                log('âœ… æµ‹è¯•é¡¹ç›®åˆ›å»ºæˆåŠŸ');
                return true;
            } else {
                if (data.error.includes('å·²å­˜åœ¨')) {
                    log('âœ… æµ‹è¯•é¡¹ç›®å·²å­˜åœ¨');
                    return true;
                } else {
                    log('âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥: ' + data.error);
                    return false;
                }
            }
        } catch (e) {
            log('âŒ åˆ›å»ºé¡¹ç›®å‡ºé”™: ' + e.message);
            return false;
        }
    }

    // åˆ›å»ºæµ‹è¯•å˜æ›´
    async function createTestChange() {
        if (!token) {
            log('âŒ è¯·å…ˆç™»å½•');
            return false;
        }

        try {
            const commitId = 'test' + Math.random().toString(36).substr(2, 6);
            log(`åˆ›å»ºæµ‹è¯•å˜æ›´ (${commitId})...`);

            const res = await fetch(`${API}/changes/manual`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    projectName: 'my-test-project',
                    branch: 'main',
                    commitId: commitId,
                    commitMessage: 'æµ‹è¯•å˜æ›´\n\n- è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å˜æ›´\n- ç”¨äºéªŒè¯ç³»ç»ŸåŠŸèƒ½',
                    authorName: 'æµ‹è¯•å¼€å‘è€…',
                    authorEmail: 'test@example.com',
                    token: token
                })
            });
            const data = await res.json();

            if (data.success) {
                log('âœ… æµ‹è¯•å˜æ›´åˆ›å»ºæˆåŠŸ: ' + data.data.changeId);
                return data.data;
            } else {
                log('âŒ å˜æ›´åˆ›å»ºå¤±è´¥: ' + data.error);
                return false;
            }
        } catch (e) {
            log('âŒ åˆ›å»ºå˜æ›´å‡ºé”™: ' + e.message);
            return false;
        }
    }

    // è·å–æ‰€æœ‰å˜æ›´
    async function getAllChanges() {
        try {
            log('è·å–å˜æ›´åˆ—è¡¨...');
            const res = await fetch(`${API}/changes`);
            const data = await res.json();

            if (data.success) {
                log(`âœ… è·å–åˆ° ${data.count} ä¸ªå˜æ›´`);
                displayChanges(data.changes);
                return data.changes;
            } else {
                log('âŒ è·å–å˜æ›´å¤±è´¥: ' + data.error);
                return [];
            }
        } catch (e) {
            log('âŒ è·å–å˜æ›´å‡ºé”™: ' + e.message);
            return [];
        }
    }

    // æ˜¾ç¤ºå˜æ›´åˆ—è¡¨
    function displayChanges(changes) {
        const div = document.getElementById('changesList');
        if (!changes || changes.length === 0) {
            div.innerHTML = '<p style="color: #666;">æš‚æ— å˜æ›´æ•°æ®</p>';
            return;
        }

        div.innerHTML = `<h4>å˜æ›´åˆ—è¡¨ (${changes.length}ä¸ª)</h4>` +
            changes.map(c => `
                    <div class="change-item">
                        <strong>${c.subject}</strong>
                        <span class="status status-${c.status.toLowerCase()}">${c.status}</span>
                        <br>
                        <small>ID: ${c.changeId} | é¡¹ç›®: ${c.projectName} | ä½œè€…: ${c.authorName}</small>
                        <br>
                        <small>ğŸ“ ${c.filesChanged} æ–‡ä»¶ | â• ${c.insertions} | â– ${c.deletions} | æ—¶é—´: ${new Date(c.createdAt).toLocaleString()}</small>
                        ${c.status === 'OPEN' ? `<br>
                            <button onclick="mergeChange('${c.changeId}')" class="success">åˆå¹¶</button>
                            <button onclick="abandonChange('${c.changeId}')" class="danger">åºŸå¼ƒ</button>` : ''}
                    </div>
                `).join('');
    }

    // åˆå¹¶å˜æ›´
    async function mergeChange(id) {
        try {
            log(`åˆå¹¶å˜æ›´: ${id}`);
            const res = await fetch(`${API}/changes/${id}/merge`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                log('âœ… åˆå¹¶æˆåŠŸ');
                getAllChanges();
            } else {
                log('âŒ åˆå¹¶å¤±è´¥: ' + data.error);
            }
        } catch (e) {
            log('âŒ åˆå¹¶å‡ºé”™: ' + e.message);
        }
    }

    // åºŸå¼ƒå˜æ›´
    async function abandonChange(id) {
        try {
            log(`åºŸå¼ƒå˜æ›´: ${id}`);
            const res = await fetch(`${API}/changes/${id}/abandon`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: 'æµ‹è¯•åºŸå¼ƒ' })
            });
            const data = await res.json();

            if (data.success) {
                log('âœ… åºŸå¼ƒæˆåŠŸ');
                getAllChanges();
            } else {
                log('âŒ åºŸå¼ƒå¤±è´¥: ' + data.error);
            }
        } catch (e) {
            log('âŒ åºŸå¼ƒå‡ºé”™: ' + e.message);
        }
    }

    // å‡†å¤‡æµ‹è¯•æ•°æ®
    async function setupTestData() {
        log('ğŸ”§ å¼€å§‹å‡†å¤‡æµ‹è¯•æ•°æ®...');

        // 1. ç¡®ä¿ç”¨æˆ·ç™»å½•
        if (!token) {
            const loginSuccess = await smartLogin();
            if (!loginSuccess) {
                log('âŒ ç™»å½•å¤±è´¥ï¼Œæ— æ³•ç»§ç»­');
                return;
            }
            await new Promise(r => setTimeout(r, 500));
        }

        // 2. åˆ›å»ºæµ‹è¯•é¡¹ç›®
        const projectSuccess = await createTestProject();
        if (!projectSuccess) {
            log('âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥ï¼Œæ— æ³•ç»§ç»­');
            return;
        }
        await new Promise(r => setTimeout(r, 500));

        // 3. åˆ›å»ºå¤šä¸ªæµ‹è¯•å˜æ›´
        const changeTypes = [
            { type: 'fix', msg: 'ä¿®å¤ç™»å½•é—®é¢˜\n\n- ä¿®å¤å¯†ç éªŒè¯é€»è¾‘\n- æ·»åŠ é”™è¯¯å¤„ç†' },
            { type: 'feat', msg: 'æ·»åŠ æ–°åŠŸèƒ½\n\n- æ·»åŠ ç”¨æˆ·ç®¡ç†ç•Œé¢\n- å®ç°æƒé™æ§åˆ¶' },
            { type: 'docs', msg: 'æ›´æ–°æ–‡æ¡£\n\n- æ›´æ–°APIæ–‡æ¡£\n- æ·»åŠ ä½¿ç”¨ç¤ºä¾‹' }
        ];

        for (let i = 0; i < changeTypes.length; i++) {
            const changeType = changeTypes[i];
            const commitId = `${changeType.type}${Date.now()}${i}`;

            try {
                const res = await fetch(`${API}/changes/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectName: 'my-test-project',
                        branch: 'main',
                        commitId: commitId,
                        commitMessage: changeType.msg,
                        authorName: `å¼€å‘è€…${i+1}`,
                        authorEmail: `dev${i+1}@example.com`,
                        token: token
                    })
                });
                const data = await res.json();

                if (data.success) {
                    log(`âœ… åˆ›å»ºå˜æ›´æˆåŠŸ: ${commitId}`);
                } else {
                    log(`âŒ åˆ›å»ºå˜æ›´å¤±è´¥: ${data.error}`);
                }
            } catch (e) {
                log(`âŒ åˆ›å»ºå˜æ›´å‡ºé”™: ${e.message}`);
            }

            await new Promise(r => setTimeout(r, 300));
        }

        log('âœ… æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆï¼');
        getAllChanges();
    }

    // æŸ¥çœ‹æ‰€æœ‰æ•°æ®
    async function viewAllData() {
        log('ğŸ“Š æŸ¥çœ‹æ‰€æœ‰æ•°æ®...');
        await getAllChanges();
    }

    // è¿è¡Œå®Œæ•´æµ‹è¯•
    async function runFullTest() {
        log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...');

        // 1. å‡†å¤‡æµ‹è¯•æ•°æ®
        await setupTestData();
        await new Promise(r => setTimeout(r, 1000));

        // 2. è·å–å¹¶æ˜¾ç¤ºå˜æ›´åˆ—è¡¨
        const changes = await getAllChanges();

        // 3. æµ‹è¯•çŠ¶æ€å˜æ›´ï¼ˆå¦‚æœæœ‰å¼€æ”¾çš„å˜æ›´ï¼‰
        const openChanges = changes.filter(c => c.status === 'OPEN');
        if (openChanges.length > 0) {
            log('æµ‹è¯•å˜æ›´çŠ¶æ€æ“ä½œ...');

            // åˆå¹¶ç¬¬ä¸€ä¸ªå˜æ›´
            await mergeChange(openChanges[0].changeId);
            await new Promise(r => setTimeout(r, 500));

            // å¦‚æœæœ‰ç¬¬äºŒä¸ªï¼Œåˆ™åºŸå¼ƒå®ƒ
            if (openChanges.length > 1) {
                await abandonChange(openChanges[1].changeId);
                await new Promise(r => setTimeout(r, 500));
            }

            // åˆ·æ–°æ˜¾ç¤º
            await getAllChanges();
        }

        log('ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆï¼');
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.onload = async function() {
        log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');

        if (token) {
            try {
                const res = await fetch(`${API}/users/me?token=${token}`);
                const data = await res.json();
                if (data.success) {
                    user = data.data;
                    document.getElementById('userInfo').textContent = `${user.displayName} - ${token}`;
                    log('âœ… è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€');
                } else {
                    token = null;
                    localStorage.removeItem('userToken');
                    log('âŒ ç™»å½•çŠ¶æ€å·²å¤±æ•ˆ');
                }
            } catch (e) {
                log('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥');
            }
        }
    };
</script>
</body>
</html>