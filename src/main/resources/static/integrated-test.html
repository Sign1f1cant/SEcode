<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ç”¨æˆ·+é¡¹ç›®é›†æˆæµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; text-align: center; }
    h2 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 10px; }

    .step {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      position: relative;
    }
    .step.completed {
      border-color: #28a745;
      background-color: #f8fff9;
    }
    .step.active {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    .step.error {
      border-color: #dc3545;
      background-color: #fff8f8;
    }

    .step-number {
      position: absolute;
      top: -10px;
      left: 20px;
      background: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      border: 2px solid #e9ecef;
    }
    .step.completed .step-number {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }
    .step.active .step-number {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .step.error .step-number {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      margin: 10px 5px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }

    .current-user {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .result {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      background: #f9f9f9;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .project-list {
      margin-top: 15px;
    }
    .project-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }
    .project-name {
      font-weight: bold;
      color: #007bff;
      font-size: 16px;
    }
    .project-creator {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ”— ç”¨æˆ·+é¡¹ç›®é›†æˆæµ‹è¯•</h1>

  <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
  <div id="currentStatus" class="current-user">
    <strong>å½“å‰çŠ¶æ€ï¼š</strong><span id="statusText">æœªå¼€å§‹æµ‹è¯•</span>
  </div>

  <!-- æ­¥éª¤1: ç”¨æˆ·æ³¨å†Œ -->
  <div class="step" id="step1">
    <div class="step-number">1</div>
    <h2>ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ</h2>
    <div class="form-group">
      <label for="regUsername">ç”¨æˆ·å *</label>
      <input type="text" id="regUsername" value="testuser1">
    </div>
    <div class="form-group">
      <label for="regEmail">é‚®ç®± *</label>
      <input type="email" id="regEmail" value="test1@example.com">
    </div>
    <div class="form-group">
      <label for="regPassword">å¯†ç  *</label>
      <input type="password" id="regPassword" value="123456">
    </div>
    <div class="form-group">
      <label for="regDisplayName">æ˜¾ç¤ºåç§°</label>
      <input type="text" id="regDisplayName" value="æµ‹è¯•ç”¨æˆ·1">
    </div>
    <button onclick="registerUser()" id="regBtn">æ³¨å†Œç”¨æˆ·</button>
    <button onclick="autoRegister()" class="success">å¿«é€Ÿæ³¨å†Œ</button>
    <div id="regResult" class="result" style="display: none;"></div>
  </div>

  <!-- æ­¥éª¤2: ç”¨æˆ·ç™»å½• -->
  <div class="step" id="step2">
    <div class="step-number">2</div>
    <h2>ğŸ” ç”¨æˆ·ç™»å½•</h2>
    <div class="form-group">
      <label for="loginUsername">ç”¨æˆ·å/é‚®ç®± *</label>
      <input type="text" id="loginUsername" value="testuser1">
    </div>
    <div class="form-group">
      <label for="loginPassword">å¯†ç  *</label>
      <input type="password" id="loginPassword" value="123456">
    </div>
    <button onclick="loginUser()" id="loginBtn" disabled>ç™»å½•</button>
    <button onclick="autoLogin()" class="success" disabled>å¿«é€Ÿç™»å½•</button>
    <div id="loginResult" class="result" style="display: none;"></div>
  </div>

  <!-- æ­¥éª¤3: åˆ›å»ºé¡¹ç›® -->
  <div class="step" id="step3">
    <div class="step-number">3</div>
    <h2>ğŸ“ åˆ›å»ºé¡¹ç›®ï¼ˆéœ€è¦ç™»å½•ï¼‰</h2>
    <div class="warning">
      âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ æ²¡æœ‰æœ¬åœ°Gitä»“åº“ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ªæˆ–ä½¿ç”¨è¿œç¨‹URL
    </div>
    <div class="form-group">
      <label for="projectName">é¡¹ç›®åç§° *</label>
      <input type="text" id="projectName" value="my-test-project">
    </div>
    <div class="form-group">
      <label for="projectDescription">é¡¹ç›®æè¿°</label>
      <textarea id="projectDescription">è¿™æ˜¯ä¸€ä¸ªé›†æˆæµ‹è¯•é¡¹ç›®</textarea>
    </div>
    <div class="form-group">
      <label for="projectGitPath">Gitä»“åº“è·¯å¾„ *</label>
      <input type="text" id="projectGitPath" value="https://github.com/octocat/Hello-World.git" placeholder="ä¾‹å¦‚: D:/test-repo æˆ– https://github.com/user/repo.git">
    </div>
    <button onclick="createProject()" id="createBtn" disabled>åˆ›å»ºé¡¹ç›®</button>
    <button onclick="autoCreateProject()" class="success" disabled>å¿«é€Ÿåˆ›å»º</button>
    <div id="createResult" class="result" style="display: none;"></div>
  </div>

  <!-- æ­¥éª¤4: æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨ -->
  <div class="step" id="step4">
    <div class="step-number">4</div>
    <h2>ğŸ“‹ é¡¹ç›®ç®¡ç†</h2>
    <button onclick="getAllProjects()" id="getAllBtn" disabled>è·å–æ‰€æœ‰é¡¹ç›®</button>
    <button onclick="getMyProjects()" id="getMyBtn" disabled>è·å–æˆ‘çš„é¡¹ç›®</button>
    <button onclick="testProjectPermission()" id="permBtn" disabled>æµ‹è¯•æƒé™æ§åˆ¶</button>
    <div id="projectResult" class="result" style="display: none;"></div>
    <div id="projectList" class="project-list"></div>
  </div>

  <!-- æ­¥éª¤5: æƒé™æµ‹è¯• -->
  <div class="step" id="step5">
    <div class="step-number">5</div>
    <h2>ğŸ”’ æƒé™éªŒè¯æµ‹è¯•</h2>
    <div class="warning">
      è¿™ä¸ªæ­¥éª¤ä¼šæµ‹è¯•å…¶ä»–ç”¨æˆ·æ˜¯å¦èƒ½ä¿®æ”¹ä½ çš„é¡¹ç›®ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    </div>
    <button onclick="createSecondUser()" id="user2Btn" disabled>åˆ›å»ºç¬¬äºŒä¸ªç”¨æˆ·</button>
    <button onclick="testCrossUserPermission()" id="crossBtn" disabled>æµ‹è¯•è·¨ç”¨æˆ·æƒé™</button>
    <div id="permissionResult" class="result" style="display: none;"></div>
  </div>

  <!-- å®Œæ•´æµ‹è¯•æ—¥å¿— -->
  <div class="step">
    <div class="step-number">ğŸ“‹</div>
    <h2>ğŸ“Š å®Œæ•´æµ‹è¯•æ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <button onclick="runCompleteTest()" class="success">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <div id="completeLog" class="result" style="height: 300px;"></div>
  </div>
</div>

<script>
  const baseUrl = 'http://localhost:8080/api';
  let currentUser = null;
  let currentToken = null;
  let testProjects = [];
  let secondUser = null;
  let secondToken = null;

  // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
  window.onload = function() {
    log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹é›†æˆæµ‹è¯•');
    updateStatus('å‡†å¤‡å¼€å§‹æµ‹è¯•...');

    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç™»å½•çŠ¶æ€
    const savedToken = localStorage.getItem('userToken');
    if (savedToken) {
      log('å‘ç°ä¿å­˜çš„tokenï¼Œå°è¯•æ¢å¤ç™»å½•çŠ¶æ€');
      currentToken = savedToken;
      checkCurrentUser();
    }
  };

  // æ—¥å¿—è®°å½•
  function log(message) {
    const logDiv = document.getElementById('completeLog');
    const timestamp = new Date().toLocaleTimeString();
    logDiv.textContent += `[${timestamp}] ${message}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
    console.log(message);
  }

  function clearLog() {
    document.getElementById('completeLog').textContent = '';
  }

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  function updateStatus(status) {
    document.getElementById('statusText').textContent = status;
  }

  // æ˜¾ç¤ºç»“æœ
  function showResult(elementId, data, isError = false) {
    const element = document.getElementById(elementId);
    element.style.display = 'block';
    element.style.color = isError ? '#dc3545' : '#28a745';
    element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
  }

  // æ›´æ–°æ­¥éª¤çŠ¶æ€
  function updateStepStatus(stepId, status) {
    const step = document.getElementById(stepId);
    step.className = 'step ' + status; // active, completed, error
  }

  // å¯ç”¨æŒ‰é’®
  function enableButtons(buttonIds) {
    buttonIds.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.disabled = false;
    });
  }

  // ========== æ­¥éª¤1: ç”¨æˆ·æ³¨å†Œ ==========
  async function registerUser() {
    updateStepStatus('step1', 'active');
    log('å¼€å§‹ç”¨æˆ·æ³¨å†Œ...');

    const userData = {
      username: document.getElementById('regUsername').value.trim(),
      email: document.getElementById('regEmail').value.trim(),
      password: document.getElementById('regPassword').value,
      displayName: document.getElementById('regDisplayName').value.trim()
    };

    log(`æ³¨å†Œç”¨æˆ·: ${userData.username} (${userData.email})`);

    try {
      const response = await fetch(`${baseUrl}/users/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      const data = await response.json();

      if (data.success) {
        log('âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ');
        showResult('regResult', 'æ³¨å†ŒæˆåŠŸï¼å¯ä»¥è¿›è¡Œç™»å½•äº†', false);
        updateStepStatus('step1', 'completed');
        updateStepStatus('step2', 'active');
        enableButtons(['loginBtn', 'autoLogin']);
        updateStatus('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
      } else {
        log('âŒ ç”¨æˆ·æ³¨å†Œå¤±è´¥: ' + data.error);
        showResult('regResult', 'æ³¨å†Œå¤±è´¥: ' + data.error, true);
        updateStepStatus('step1', 'error');
      }
    } catch (error) {
      log('âŒ æ³¨å†Œè¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('regResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
      updateStepStatus('step1', 'error');
    }
  }

  async function autoRegister() {
    log('æ‰§è¡Œå¿«é€Ÿæ³¨å†Œ...');
    await registerUser();
  }

  // ========== æ­¥éª¤2: ç”¨æˆ·ç™»å½• ==========
  async function loginUser() {
    updateStepStatus('step2', 'active');
    log('å¼€å§‹ç”¨æˆ·ç™»å½•...');

    const loginData = {
      usernameOrEmail: document.getElementById('loginUsername').value.trim(),
      password: document.getElementById('loginPassword').value
    };

    log(`ç™»å½•ç”¨æˆ·: ${loginData.usernameOrEmail}`);

    try {
      const response = await fetch(`${baseUrl}/users/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(loginData)
      });

      const data = await response.json();

      if (data.success) {
        currentUser = data.data;
        currentToken = data.data.token;
        localStorage.setItem('userToken', currentToken);

        log('âœ… ç”¨æˆ·ç™»å½•æˆåŠŸï¼ŒToken: ' + currentToken);
        showResult('loginResult', `ç™»å½•æˆåŠŸï¼\nç”¨æˆ·: ${currentUser.displayName}\nToken: ${currentToken}`, false);
        updateStepStatus('step2', 'completed');
        updateStepStatus('step3', 'active');
        enableButtons(['createBtn', 'autoCreateProject']);
        updateStatus(`å·²ç™»å½•: ${currentUser.displayName}`);
      } else {
        log('âŒ ç”¨æˆ·ç™»å½•å¤±è´¥: ' + data.error);
        showResult('loginResult', 'ç™»å½•å¤±è´¥: ' + data.error, true);
        updateStepStatus('step2', 'error');
      }
    } catch (error) {
      log('âŒ ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('loginResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
      updateStepStatus('step2', 'error');
    }
  }

  async function autoLogin() {
    log('æ‰§è¡Œå¿«é€Ÿç™»å½•...');
    await loginUser();
  }

  // æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€
  async function checkCurrentUser() {
    if (!currentToken) return;

    try {
      const response = await fetch(`${baseUrl}/users/me?token=${currentToken}`);
      const data = await response.json();

      if (data.success) {
        currentUser = data.data;
        log('âœ… ç™»å½•çŠ¶æ€æ¢å¤æˆåŠŸ');
        updateStepStatus('step1', 'completed');
        updateStepStatus('step2', 'completed');
        updateStepStatus('step3', 'active');
        enableButtons(['createBtn', 'autoCreateProject', 'getAllBtn', 'getMyBtn', 'permBtn']);
        updateStatus(`å·²ç™»å½•: ${currentUser.displayName}`);
      } else {
        log('âŒ Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
        currentToken = null;
        currentUser = null;
        localStorage.removeItem('userToken');
      }
    } catch (error) {
      log('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message);
    }
  }

  // ========== æ­¥éª¤3: åˆ›å»ºé¡¹ç›® ==========
  async function createProject() {
    updateStepStatus('step3', 'active');
    log('å¼€å§‹åˆ›å»ºé¡¹ç›®...');

    const projectData = {
      name: document.getElementById('projectName').value.trim(),
      description: document.getElementById('projectDescription').value.trim(),
      gitPath: document.getElementById('projectGitPath').value.trim(),
      token: currentToken
    };

    log(`åˆ›å»ºé¡¹ç›®: ${projectData.name} -> ${projectData.gitPath}`);

    try {
      const response = await fetch(`${baseUrl}/projects`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + currentToken
        },
        body: JSON.stringify(projectData)
      });

      const data = await response.json();

      if (data.success) {
        testProjects.push(data.data);
        log('âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ: ' + projectData.name);
        showResult('createResult', `é¡¹ç›®åˆ›å»ºæˆåŠŸï¼\né¡¹ç›®å: ${data.data.name}\nåˆ›å»ºè€…ID: ${data.data.creatorId}`, false);
        updateStepStatus('step3', 'completed');
        updateStepStatus('step4', 'active');
        enableButtons(['getAllBtn', 'getMyBtn', 'permBtn']);
        updateStatus('é¡¹ç›®åˆ›å»ºæˆåŠŸï¼Œå¯ä»¥æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨');
      } else {
        log('âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥: ' + data.error);
        showResult('createResult', 'åˆ›å»ºå¤±è´¥: ' + data.error, true);
        updateStepStatus('step3', 'error');
      }
    } catch (error) {
      log('âŒ åˆ›å»ºé¡¹ç›®è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('createResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
      updateStepStatus('step3', 'error');
    }
  }

  async function autoCreateProject() {
    log('æ‰§è¡Œå¿«é€Ÿé¡¹ç›®åˆ›å»º...');

    // ä½¿ç”¨ç¤ºä¾‹Gitä»“åº“
    document.getElementById('projectName').value = 'demo-project-' + Date.now();
    document.getElementById('projectGitPath').value = 'https://github.com/octocat/Hello-World.git';

    await createProject();
  }

  // ========== æ­¥éª¤4: é¡¹ç›®ç®¡ç† ==========
  async function getAllProjects() {
    log('è·å–æ‰€æœ‰é¡¹ç›®...');

    try {
      const response = await fetch(`${baseUrl}/projects`);
      const data = await response.json();

      if (data.success) {
        log(`âœ… è·å–åˆ° ${data.count} ä¸ªé¡¹ç›®`);
        showResult('projectResult', `æ‰¾åˆ° ${data.count} ä¸ªé¡¹ç›®`, false);
        displayProjects(data.projects, 'æ‰€æœ‰é¡¹ç›®');
      } else {
        log('âŒ è·å–é¡¹ç›®å¤±è´¥: ' + data.error);
        showResult('projectResult', 'è·å–å¤±è´¥: ' + data.error, true);
      }
    } catch (error) {
      log('âŒ è·å–é¡¹ç›®è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('projectResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
    }
  }

  async function getMyProjects() {
    log('è·å–æˆ‘çš„é¡¹ç›®...');

    try {
      const response = await fetch(`${baseUrl}/projects?my=true`, {
        headers: { 'Authorization': 'Bearer ' + currentToken }
      });
      const data = await response.json();

      if (data.success) {
        log(`âœ… æˆ‘åˆ›å»ºäº† ${data.count} ä¸ªé¡¹ç›®`);
        showResult('projectResult', `æˆ‘çš„é¡¹ç›®: ${data.count} ä¸ª`, false);
        displayProjects(data.projects, 'æˆ‘çš„é¡¹ç›®');
      } else {
        log('âŒ è·å–æˆ‘çš„é¡¹ç›®å¤±è´¥: ' + data.error);
        showResult('projectResult', 'è·å–å¤±è´¥: ' + data.error, true);
      }
    } catch (error) {
      log('âŒ è·å–æˆ‘çš„é¡¹ç›®è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('projectResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
    }
  }

  // æ˜¾ç¤ºé¡¹ç›®åˆ—è¡¨
  function displayProjects(projects, title) {
    const listDiv = document.getElementById('projectList');

    if (!projects || projects.length === 0) {
      listDiv.innerHTML = `<h4>${title}</h4><p style="color: #666;">æš‚æ— é¡¹ç›®</p>`;
      return;
    }

    listDiv.innerHTML = `<h4>${title} (${projects.length}ä¸ª)</h4>` +
            projects.map(project => `
                    <div class="project-item">
                        <div class="project-name">${project.name}</div>
                        <div>${project.description || 'æ— æè¿°'}</div>
                        <div style="font-family: monospace; font-size: 12px; color: #666;">ğŸ“ ${project.gitPath}</div>
                        <div class="project-creator">
                            åˆ›å»ºè€…ID: ${project.creatorId} |
                            é»˜è®¤åˆ†æ”¯: ${project.defaultBranch} |
                            åˆ›å»ºæ—¶é—´: ${new Date(project.createdAt).toLocaleString()}
                        </div>
                    </div>
                `).join('');
  }

  async function testProjectPermission() {
    log('æµ‹è¯•é¡¹ç›®æƒé™æ§åˆ¶...');

    if (testProjects.length === 0) {
      log('âŒ æ²¡æœ‰æµ‹è¯•é¡¹ç›®ï¼Œè¯·å…ˆåˆ›å»ºé¡¹ç›®');
      return;
    }

    const projectName = testProjects[0].name;
    log(`æµ‹è¯•ä¿®æ”¹é¡¹ç›®: ${projectName}`);

    try {
      const response = await fetch(`${baseUrl}/projects/${projectName}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + currentToken
        },
        body: JSON.stringify({
          description: 'ä¿®æ”¹åçš„æè¿° - ' + new Date().toLocaleTimeString()
        })
      });

      const data = await response.json();

      if (data.success) {
        log('âœ… é¡¹ç›®ä¿®æ”¹æˆåŠŸï¼ˆæƒé™éªŒè¯é€šè¿‡ï¼‰');
        showResult('projectResult', 'æƒé™æµ‹è¯•é€šè¿‡ï¼šå¯ä»¥ä¿®æ”¹è‡ªå·±çš„é¡¹ç›®', false);
        updateStepStatus('step4', 'completed');
        updateStepStatus('step5', 'active');
        enableButtons(['user2Btn']);
      } else {
        log('âŒ é¡¹ç›®ä¿®æ”¹å¤±è´¥: ' + data.error);
        showResult('projectResult', 'æƒé™æµ‹è¯•å¤±è´¥: ' + data.error, true);
      }
    } catch (error) {
      log('âŒ æƒé™æµ‹è¯•è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('projectResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
    }
  }

  // ========== æ­¥éª¤5: æƒé™éªŒè¯ ==========
  async function createSecondUser() {
    log('åˆ›å»ºç¬¬äºŒä¸ªç”¨æˆ·ç”¨äºæƒé™æµ‹è¯•...');

    const userData = {
      username: 'testuser2',
      email: 'test2@example.com',
      password: '123456',
      displayName: 'æµ‹è¯•ç”¨æˆ·2'
    };

    try {
      // æ³¨å†Œç¬¬äºŒä¸ªç”¨æˆ·
      const regResponse = await fetch(`${baseUrl}/users/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      const regData = await regResponse.json();

      if (regData.success) {
        log('âœ… ç¬¬äºŒä¸ªç”¨æˆ·æ³¨å†ŒæˆåŠŸ');

        // ç™»å½•ç¬¬äºŒä¸ªç”¨æˆ·
        const loginResponse = await fetch(`${baseUrl}/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            usernameOrEmail: 'testuser2',
            password: '123456'
          })
        });

        const loginData = await loginResponse.json();

        if (loginData.success) {
          secondUser = loginData.data;
          secondToken = loginData.data.token;
          log('âœ… ç¬¬äºŒä¸ªç”¨æˆ·ç™»å½•æˆåŠŸï¼ŒToken: ' + secondToken);
          showResult('permissionResult', `ç¬¬äºŒä¸ªç”¨æˆ·åˆ›å»ºæˆåŠŸï¼\nç”¨æˆ·: ${secondUser.displayName}\nToken: ${secondToken}`, false);
          enableButtons(['crossBtn']);
        }
      } else {
        if (regData.error.includes('å·²å­˜åœ¨')) {
          // ç”¨æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥ç™»å½•
          log('ç”¨æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥ç™»å½•...');
          const loginResponse = await fetch(`${baseUrl}/users/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              usernameOrEmail: 'testuser2',
              password: '123456'
            })
          });

          const loginData = await loginResponse.json();
          if (loginData.success) {
            secondUser = loginData.data;
            secondToken = loginData.data.token;
            log('âœ… ç¬¬äºŒä¸ªç”¨æˆ·ç™»å½•æˆåŠŸ');
            showResult('permissionResult', `ç¬¬äºŒä¸ªç”¨æˆ·ç™»å½•æˆåŠŸï¼\nç”¨æˆ·: ${secondUser.displayName}`, false);
            enableButtons(['crossBtn']);
          }
        } else {
          log('âŒ åˆ›å»ºç¬¬äºŒä¸ªç”¨æˆ·å¤±è´¥: ' + regData.error);
          showResult('permissionResult', 'åˆ›å»ºå¤±è´¥: ' + regData.error, true);
        }
      }
    } catch (error) {
      log('âŒ åˆ›å»ºç¬¬äºŒä¸ªç”¨æˆ·è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('permissionResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
    }
  }

  async function testCrossUserPermission() {
    log('æµ‹è¯•è·¨ç”¨æˆ·æƒé™æ§åˆ¶...');

    if (!secondToken || testProjects.length === 0) {
      log('âŒ ç¼ºå°‘ç¬¬äºŒä¸ªç”¨æˆ·tokenæˆ–æµ‹è¯•é¡¹ç›®');
      return;
    }

    const projectName = testProjects[0].name;
    log(`ç”¨æˆ·2å°è¯•ä¿®æ”¹ç”¨æˆ·1çš„é¡¹ç›®: ${projectName}`);

    try {
      const response = await fetch(`${baseUrl}/projects/${projectName}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + secondToken
        },
        body: JSON.stringify({
          description: 'ç”¨æˆ·2å°è¯•ä¿®æ”¹çš„æè¿°'
        })
      });

      const data = await response.json();

      if (data.success) {
        log('âŒ æƒé™æ§åˆ¶å¤±è´¥ï¼ç”¨æˆ·2èƒ½å¤Ÿä¿®æ”¹ç”¨æˆ·1çš„é¡¹ç›®');
        showResult('permissionResult', 'âš ï¸ æƒé™æ§åˆ¶æœ‰é—®é¢˜ï¼šå…¶ä»–ç”¨æˆ·å¯ä»¥ä¿®æ”¹é¡¹ç›®', true);
      } else {
        log('âœ… æƒé™æ§åˆ¶æ­£å¸¸ï¼ç”¨æˆ·2æ— æ³•ä¿®æ”¹ç”¨æˆ·1çš„é¡¹ç›®');
        showResult('permissionResult', `âœ… æƒé™æ§åˆ¶æ­£å¸¸ï¼\né”™è¯¯ä¿¡æ¯: ${data.error}`, false);
        updateStepStatus('step5', 'completed');
      }
    } catch (error) {
      log('âŒ è·¨ç”¨æˆ·æƒé™æµ‹è¯•è¯·æ±‚å¤±è´¥: ' + error.message);
      showResult('permissionResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, true);
    }
  }

  // ========== å®Œæ•´è‡ªåŠ¨æµ‹è¯• ==========
  async function runCompleteTest() {
    log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•...');
    updateStatus('æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...');

    try {
      // æ¸…ç†ä¹‹å‰çš„çŠ¶æ€
      clearLog();
      log('ğŸ“‹ å®Œæ•´é›†æˆæµ‹è¯•å¼€å§‹');

      // æ­¥éª¤1: æ³¨å†Œç”¨æˆ·
      log('æ­¥éª¤1: æ³¨å†Œæµ‹è¯•ç”¨æˆ·...');
      document.getElementById('regUsername').value = 'autotest' + Date.now();
      document.getElementById('regEmail').value = `autotest${Date.now()}@example.com`;
      document.getElementById('regPassword').value = '123456';
      document.getElementById('regDisplayName').value = 'è‡ªåŠ¨æµ‹è¯•ç”¨æˆ·';

      await registerUser();
      await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’

      // æ­¥éª¤2: ç™»å½•ç”¨æˆ·
      log('æ­¥éª¤2: ç™»å½•æµ‹è¯•ç”¨æˆ·...');
      document.getElementById('loginUsername').value = document.getElementById('regUsername').value;
      document.getElementById('loginPassword').value = '123456';

      await loginUser();
      await new Promise(resolve => setTimeout(resolve, 1000));

      // æ­¥éª¤3: åˆ›å»ºé¡¹ç›®
      log('æ­¥éª¤3: åˆ›å»ºæµ‹è¯•é¡¹ç›®...');
      document.getElementById('projectName').value = 'autotest-project-' + Date.now();
      document.getElementById('projectDescription').value = 'è‡ªåŠ¨æµ‹è¯•åˆ›å»ºçš„é¡¹ç›®';
      document.getElementById('projectGitPath').value = 'https://github.com/octocat/Hello-World.git';

      await createProject();
      await new Promise(resolve => setTimeout(resolve, 1000));

      // æ­¥éª¤4: æµ‹è¯•é¡¹ç›®ç®¡ç†
      log('æ­¥éª¤4: æµ‹è¯•é¡¹ç›®ç®¡ç†åŠŸèƒ½...');
      await getAllProjects();
      await new Promise(resolve => setTimeout(resolve, 500));
      await getMyProjects();
      await new Promise(resolve => setTimeout(resolve, 500));
      await testProjectPermission();
      await new Promise(resolve => setTimeout(resolve, 1000));

      // æ­¥éª¤5: æµ‹è¯•æƒé™æ§åˆ¶
      log('æ­¥éª¤5: æµ‹è¯•æƒé™æ§åˆ¶...');
      await createSecondUser();
      await new Promise(resolve => setTimeout(resolve, 1000));
      await testCrossUserPermission();

      log('ğŸ‰ å®Œæ•´é›†æˆæµ‹è¯•å®Œæˆï¼');
      updateStatus('å®Œæ•´æµ‹è¯•å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸');

    } catch (error) {
      log('âŒ å®Œæ•´æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
      updateStatus('æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
    }
  }
</script>
</body>
</html>